name: Move issues between columns on close/reopen

on:
  issues:
    types: [closed, reopened]

jobs:
  move_card:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      projects: write
    steps:
      - name: Move card based on issue state
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const todoColumnId = "f75ad846";
            const doneColumnId = "98236657";

            // Find the project card connected to this issue
            const cards = await github.rest.projects.listCards({
              column_id: todoColumnId,
              per_page: 100
            });
            const doneCards = await github.rest.projects.listCards({
              column_id: doneColumnId,
              per_page: 100
            });

            const allCards = [...cards.data, ...doneCards.data];
            const issueCard = allCards.find(c => c.content_url && c.content_url.endsWith(`/issues/${context.issue.number}`));

            if (!issueCard) {
              console.log("No project card found for this issue.");
              return;
            }

            const targetColumn = context.payload.issue.state === "closed" ? doneColumnId : todoColumnId;

            if (issueCard.column_id === targetColumn) {
              console.log("Card already in the correct column.");
              return;
            }

            await github.rest.projects.moveCard({
              card_id: issueCard.id,
              position: "top",
              column_id: targetColumn
            });

            console.log(`Moved issue #${context.issue.number} to column ${targetColumn}.`);
